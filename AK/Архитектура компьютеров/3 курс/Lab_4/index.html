<!doctype html>
<html>
<head><meta charset="utf-8"><link rel=stylesheet href="../style.css"><title>CPU ID</title>
</head>
<body>
<a href="../index.html">Содержание</a>
<h1>Лабораторная работа 4. Идентификация процессоров cемейства x86-64</h1>
<hr>

<h2>4.1 Цель работы</h2>
<p>Изучение способов идентификации микропроцессоров, совместимых с архитектурой семейства Intel x86-64; получение практических навыков по разработке низкоуровневых программ, определяющих тип установленного центрального процессора.</p>

<h2>4.2 Самостоятельная работа студентов</h2>
<p>Выполнение работы базируется на знании базовой архитектуры прикладного и системного уровней микропроцессоров семейства x86-64.</p>
<p>С целью получения практических навыков по разработке и выполнению программ, определяющих тип CPU, необходимо самостоятельно составить программу в соответствии с вариантом задания.</p>
<p>Следует знать, что не существует единственного универсального метода идентификации всех микропроцессоров архитектурного семейства x86-64. Поэтому для определения типа любого из процессоров указанного семейства необходимо совместное использование нескольких способов и средств.</p>

<h3>4.2.1	Идентификация по регистру флагов</h3>
<p>Одним из простых способов идентификации является контроль за изменением разрядов в регистре флагов (E)FLAGS (<a target="_blank" href="../CA_appendix.pdf#%5B%7B%22num%22%3A15%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C54%2C790%2C0%5D">приложение А</a>). При этом используются следующие биты указанного регистра: ID, VIP и VIF, которые присутствуют в регистре флагов процессоров, начиная с процессора Pentium (P5); AC (i486); VM, RF (i386); NT, поле IOPL (i286).</p>
<p>Для идентификации 16-битных процессоров анализируют значение разрядов 12-15 регистра флагов после попыток его модификации:</p>
<ul>
<li>у процессоров 8086/88 они всегда установлены, и попытка сбросить их не удается;</li>
<li>у процессоров i286 в реальном режиме они всегда сброшены.</li>
</ul>
<p>Для идентификации 32-битных процессоров анализируется содержимое EFLAGS:</p>
<ul>
<li>биты 12-15:</li>
<ol type="a">
<li>в реальном режиме бит 15 сброшен всегда, биты 12-14 хранят последнее загруженное в них значение;</li>
<li>в защищенном режиме бит 15 сброшен всегда, бит 14 хранит последнее в него загруженное значение; биты 12, 13 можно изменить только при IOPL=0;</li>
</ol>
<li>бит 18 определен у процессоров, начиная с i486, поэтому в i386 его невозможно изменить;
<li>бит 21 определяет возможность использования инструкции CPUID; признаком доступности инструкции является возможность программного изменения его значения.</li>
</ul>
<p>Для обращения к регистрам FLAGS и EFLAGS используются команды PUSHF/POPF и PUSHFD/POPFD, соответственно. Фрагмент программы, определяющей тип процессора 8086/8088 по регистру флагов приведен в <a href="#p4_3_1">примере 4.3.1</a>.</p>

<h3>4.2.2	Сигнатура идентификации CPU</h3>
<p>BIOS может получить информацию о типе 32-разрядного процессора в виде сигнатуры идентификации, которая формируется в регистре EDX непосредственно после сигнала сброса процессора (рис. 4.1). Следует обратить внимание на некоторые отличия сигнатуры современных микропроцессоров от i386.</p>
<p class="center"><img src="fig_4_1a.png" alt="Рисунок 4.1, а" /></p>
<p class="center">а)</p>
<p class="center"><img src="fig_4_1b.png" alt="Рисунок 4.1, б" /></p>
<p class="center">б)</p>
<p class="center">Рисунок 4.1 – Сигнатура идентификации процессора:<br />а) в регистре EDX процессора i386 после его сброса; <br />б) в регистре EAX процессоров i486+ после выполнения CPUID с EAX = 1</p>
<p></p>
<p>Поле "Extended family" (биты 20-27) используется совместно с "Family code" (биты 8-11) для обозначения принадлежности процессора семействам i386, i486, Pentium, Pentium Pro или Pentium 4. Семейство P6 включает все процессоры, основанные на микроархитектуре Pentium Pro, имеет значение поля "Extended family" равное 00h и значение поля "Family code" равное 06h. Семейство Pentium 4 включает все процессоры, основанные на микроархитектуре Intel NetBurst, имеет значение поля "Extended family" равное 00h, значение поля "Family code" равное 0Fh.</p>
<p>Поле "Extended model" (биты 16-19) используется совместно с полем "Model number" (биты 4-7) для обозначения модели процессора в рамках семейства.</p>
<p>Поле "Stepping ID" (биты 0-3) обозначает модификацию (ревизию) конкретной модели.</p>
<p>Поле "Type" (биты 12 и 13) может обозначать, что процессор является оригинальным OEM-процессором (00), OverDrive-процессором (01) или процессором, который может быть использован в двухпроцессорных системах (10).</p>
<p>Возможность получения сигнатуры процессора в любое время без необходимости сброса присутствует в процессорах, поддерживающих команду CPUID (см. <a href="#p4_2_3">4.2.3</a>). Такая поддержка была реализована, начиная с поздних версий процессоров i486.</p>

<h3><a name="p4_2_3"></a>4.2.3 Команда CPUID</h3>

<p>Команда CPUID предоставляет программному обеспечению подробную информацию о процессоре, на котором она выполнена. Ее функция определяется содержимым регистра EAX в момент вызова. Все множество поддерживаемых функций разделено на два подмножества: функции первого и второго подмножеств возвращают, соответственно, базовую и расширенную информацию о процессоре.</p>
<p>В табл. 4.1 показаны входные и выходные параметры нескольких базовых функций команды CPUID.</p>
<p></p>
<p class="center">Таблица 4.1 – Параметры команды CPUID</p>
<div class="center">
<table>
<tr><th>Входной параметр</th><th>Выходной параметр</th></tr>
<tr><td rowspan="2">EAX = 0</td><td>EAX = max – наивысшее значение входного параметра, воспринимаемое командой CPUID</td></tr>
<tr><td>EBX:EDX:ECX – строка идентификации производителя</td></tr>
<tr><td rowspan="3">EAX = 1</td><td>EAX – сигнатура идентификации процессора (рис. 4.1)</td></tr>
<tr><td>ECX:EDX – флаги свойств (<a target="_blank" href="../CA_appendix.pdf#%5B%7B%22num%22%3A98%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C68%2C790%2C0%5D">таблицы Г.1, Г.2</a>)</td></tr>
<tr><td>EBX – дополнительная информация (рис. 4.2)</td></tr>
<tr><td>EAX = 2</td><td>EAX, EBX, ECX, EDX – параметры конфигурации процессора</td></tr>
<tr><td>. . .</td><td>. . .</td></tr>
<tr><td>EAX > max</td><td>EAX, EBX, ECX, EDX не определены (не используются)</td></tr>
</table>
</div>
<p>Для того, чтобы определить максимально допустимое значение входного параметра базовых функций команды CPUID, необходимо загрузить в регистр EAX значение 0, а затем выполнить команду CPUID:</p>
<listing>
	mov EAX, 0
	cpuid
</listing>
<p>После такого вызова команды CPUID регистр EAX будет содержать наивысшее значение входного параметра базовых функций. Кроме того, будет возвращена текстовая строка идентификации производителя ("Vendor ID"), состоящая из трех частей по четыре символа (в регистре EBX первые четыре ASCII-кода символа, в EDX – следующие, в ECX – последние).</p>
<p>Выполнение команды CPUID со значением EAX = 1 позволяет получить сигнатуру идентификации CPU, которая возвращается в регистре EAX.</p>
<p>Помимо сигнатуры, будет предоставлена также некоторая дополнительная информация в регистре EBX:</p>
<ul>
<li>поле "Brand ID" (биты 0-7) – значение индекса элемента таблицы, содержащей текстовые строки брендов ("Brand strings") процессоров IA-32; нулевое значение поля указывает на отсутствие поддержки таблицы брендов;</li>
<li>поле "Chunks" (биты 8-15) – значение размера строки кэша (в 8-байтных блоках) flushed посредством команды CLFLUSH;</li>
<li>поле "Count" (биты 16-23) – максимальное количество логических процессоров в одном модуле; для процессоров, поддерживающих технологию Multithreading (<a target="_blank" href="../CA_appendix.pdf#%5B%7B%22num%22%3A98%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C68%2C790%2C0%5D">приложение Г</a>) – в одном физическом корпусе;</li>
<li>поле "APIC ID" (биты 24-31) – 8-битный идентификатор, назначенный локальному модулю APIC процессора при включении питания.</li>
</ul>
<p class="center"><img src="fig_4_2.png" alt="Рисунок 4.2" /></p>
<p class="center">Рисунок 4.2 – Содержимое регистра EBX после выполнения команды CPUID с EAX = 1</p>
<p></p>
<p>Кроме того, в регистрах EDX и ECX будут расположены флаги свойств ("Feature flags", <a target="_blank" href="../CA_appendix.pdf#%5B%7B%22num%22%3A98%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C68%2C790%2C0%5D">таблицы Г.1, Г.2</a>). Единичные значения разрядов означают поддержку процессором соотвествующих свойств. Используя данную информацию, программное обеспечение может выявить и предотвратить возможные несовместимости с различными свойствами процессора, добавляемыми или удаляемыми производителями.</p>

<h3>4.2.3 Прочие способы идентификации</h3>
<p>По аналогии с методом идентификации по регистру флагов процессор можно идентифицировать по выполнению команд, поддерживаемых им (или процессором выше). При выполнении этих команд на процессорах ниже предполагаемого возникает особый случай – недействительный код операции (прерывание 6). Используемые с указанной целью команды:</p>
<listing>
	cmpxchg8b	; (Pentium+)
	xadd DX, DX	; (i486+)
	mov  EDX, CR0	; (i386+)
	smsw DX		; (i286)
	shl  DX, 5	; (80186).
</listing>
<p>Идентифицировать процессор также возможно, выполнив на нем определенное количество команд и сравнив время их выполнения с табличным значением. При этом помимо типа процессора можно определить и его тактовую частоту. Однако данный способ не всегда дает верный тип процессора, который был «разогнан».</p>
<p>Для идентификации специфических процессоров 8086/88 фирмы NEC, различных DLC и SLC фирмы СYRIX и т.п. существуют определенные библиотеки программ, а также описания, предоставляемые производителями данных процессоров.</p>
<h2>4.3 Примеры выполнения практических заданий</h2>
<h3><a name="p4_3_1"></a>4.3.1 Определение процессора 8086/8088 по регистру флагов</h3>
<listing>
	; фрагмент ассемблерной вставки:

		pushf		; сохранить копию р-ра флагов
		pop BX		; восстановить в BX

		mov AX,0FFFh	; очистить биты 12-15 в AX
		and AX,BX

		push AX		; сохранить новое значение флагов
		popf

		pushf		; установить регистр флагов
		pop AX		; сохранить копию нового р-ра флагов в AX

		mov CX,0F000h
		and AX,CX	; если биты 12-15 установлены,
		cmp AX,CX	; это процессор 8086/88

		jne non_8086	; переход, если не 8086/88
		jmp cputype_8086; печать типа процессора 8086/88

	non_8086: mov AX, 0	; это не 8086/88 процессор

	cputype_8086: mov AX, 1	; это 8086/88 процессор  
</listing>

<h2>4.4	Порядок выполнения работы</h2>
<p>Выполнение работы состоит в разработке, отладке и выполнении ассемблерных программ для идентификации CPU в среде разработки Visual C++. Основные этапы работы в среде Visual C++ рассмотрены в <a href="../Lab_2/index.html#p2_4">лабораторной работе 2 (п. 2.4)</a>.</p>
<ol>
<li>Используя регистр флагов, необходимо убедиться в наличии 32-разрядного процессора в системе.</li>
<li>Убедиться в поддержке команды CPUID (посредством бита ID регистра EFLAGS) и определить максимальное значение параметра ее вызова.</li>
<li>Получить строку идентификации производителя процессора и сохранить ее в памяти.</li>
<li>Получить сигнатуру процессора и определить его модель, семейство и т.п. Выполнить анализ дополнительной информации о процессоре.</li>
<li>Получить флаги свойств. Составить список поддерживаемых процессором свойств.</li>
</ol>

<h2>4.5	Содержание отчета</h2>
<p>Отчет о лабораторной работе должен содержать:</p>
<ul>
<li>цель работы;</li>
<li>краткое описание теоретических основ;</li>
<li>постановку задачи;</li>
<li>экспериментально-практическую часть (включая анализ результатов);</li>
<li>выводы по работе.</li>
</ul>
<p>В экспериментально-практической части необходимо привести исходные тексты разработанных программ (на языке C++ с ассемблерными вставками) и результаты их выполнения, полученные в регистрах CPU и (или) ячейках памяти.</p>

<h2>4.7	Контрольные вопросы</h2>
<ol>
<li>Какие существуют способы идентификации типа процессора? Назовите их достоинства и недостатки.</li>
<li>Перечислите биты регистра флагов и укажите их назначение.</li>
<li>Каким образом можно идентифицировать процессоры 8088 и 8086?</li>
<li>Что можно определить по степпингу и семейству процессора?</li>
<li>Как можно использовать BIOS и команду CPUID при идентификации процессора?</li>
<li>Что представляют собой флаги свойств?</li>
<li>В чем заключается отличие в назначении полей "Vendor ID" и "Brand ID"?</li>
</ol>
</body>
</html>
